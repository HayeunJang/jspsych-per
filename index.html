<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audio Rating Task</title>
  <link rel="stylesheet" href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css">
  <script src="https://unpkg.com/jspsych@8.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-audio-slider-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@2.0.0"></script>
</head>
<body>
  <div id="jspsych-target"></div>
  
  <script>
    /******************************************************
     * Audio Rating Task (slider) + Google Sheets upload
     ******************************************************/

    /* ===== CONFIG ===== */
    const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbx_V4Ay6Nzl1sw94IMxKUL_a0E-t9w-pNsvRpi3WV_GMWx9lLCuUhP1Q2ZtQTJ2yINz1A/exec';

    /* ===== UI TEXTS ===== */
    const TEXTS = {
      welcomeTitle: 'Audio Rating Task',
      welcomeBody: 'You will hear short sounds and rate them on a scale.',
      startBtn: 'Start',
      prompt: 'How strongly did this sound match the "sarcastic" category?',
      leftLabel: 'Not at all',
      rightLabel: 'Very strongly',
      endTitle: 'Thanks!',
      endBody: 'Your data have been prepared. If upload fails, use the CSV button.',
      finishBtn: 'Finish'
    };

    /* ===== STIMULI ===== */
    const STIMULI = [
      { file: 'audio/amazed.wav' },
      { file: 'audio/sarcastic.wav' }
    ];

    /* ===== SLIDER SETTINGS ===== */
    const SLIDER = {
      min: 1, max: 7, step: 1, start: 4, require_movement: true,
      labels: ['1','2','3','4','5','6','7']
    };

    /* ===== INIT ===== */
    const jsPsych = initJsPsych({
      display_element: 'jspsych-target',
      on_finish: async () => {
        const ok = await uploadAllRowsToGoogle();
        if (!ok) {
          const csv = jsPsych.data.get().csv();
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; 
          a.download = 'data_fallback.csv';
          a.textContent = 'Download CSV (upload failed)';
          a.style.display = 'block';
          a.style.margin = '20px auto';
          a.style.textAlign = 'center';
          document.body.appendChild(a);
        }
      }
    });

    /* ===== PRELOAD ===== */
    const preload = {
      type: jsPsychPreload,
      audio: STIMULI.map(s => s.file)
    };

    /* ===== SCREENS ===== */
    const welcome = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `<h2>${TEXTS.welcomeTitle}</h2><p>${TEXTS.welcomeBody}</p>`,
      choices: [TEXTS.startBtn]
    };

    const end = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `<h2>${TEXTS.endTitle}</h2><p>${TEXTS.endBody}</p>`,
      choices: [TEXTS.finishBtn]
    };

    /* ===== DEMOGRAPHIC SURVEY ===== */
    const demographics = {
      type: jsPsychSurveyHtmlForm,
      preamble: '<h3>참가자 정보</h3><p>아래 정보를 입력해주세요.</p>',
      html: `
        <div style="text-align: left; max-width: 500px; margin: 0 auto;">
          <p><label for="gender"><strong>성별:</strong></label><br>
          <input type="radio" name="gender" value="남" required> 남
          <input type="radio" name="gender" value="여" required> 여</p>
          
          <p><label for="birth_year"><strong>태어난 해:</strong></label><br>
          <input type="text" id="birth_year" name="birth_year" placeholder="YYYY (예: 1995)" pattern="[0-9]{4}" required style="width: 150px;"></p>
          
          <p><label for="birth_month"><strong>태어난 월:</strong></label><br>
          <input type="text" id="birth_month" name="birth_month" placeholder="MM (예: 03)" pattern="[0-9]{2}" required style="width: 80px;"></p>
          
          <p><label for="native_lang"><strong>모국어:</strong></label><br>
          <input type="text" id="native_lang" name="native_lang" placeholder="예: 한국어" required style="width: 200px;"></p>
          
          <p><label for="dialect"><strong>방언:</strong></label><br>
          <input type="text" id="dialect" name="dialect" placeholder="예: 서울, 경상도" style="width: 200px;"></p>
          
          <p><label for="foreign_lang"><strong>외국어:</strong></label><br>
          <input type="text" id="foreign_lang" name="foreign_lang" placeholder="예: 영어, 일본어" style="width: 300px;"></p>
        </div>
      `,
      button_label: '제출',
      data: { task: 'demographics' },
      on_finish: (data) => {
        data.user_agent = navigator.userAgent;
        data.timestamp = new Date().toISOString();
        console.log('Demographics:', data.response);
      }
    };

    /* ===== RATING TRIAL ===== */
    let audioEndTime = null; // 전역 변수로 오디오 종료 시점 저장

    const rating_trial = {
      type: jsPsychAudioSliderResponse,
      stimulus: jsPsych.timelineVariable('file'),
      prompt: `<p>${TEXTS.prompt}</p>
               <div style="display:flex;justify-content:space-between;font-size:0.9rem;margin-top:4px;">
                <span>${TEXTS.leftLabel}</span><span>${TEXTS.rightLabel}</span>
               </div>`,
      min: SLIDER.min,
      max: SLIDER.max,
      slider_start: SLIDER.start,
      step: SLIDER.step,
      labels: SLIDER.labels,
      require_movement: SLIDER.require_movement,
      response_allowed_while_playing: false,
      trial_ends_after_audio: false,
      data: { 
        task: 'rating', 
        stimulus_file: jsPsych.timelineVariable('file')
      },
      on_load: function() {
        // 오디오 재생 종료 시점 기록
        audioEndTime = null; // 초기화
        const audio = document.querySelector('audio');
        if (audio) {
          audio.addEventListener('ended', () => {
            audioEndTime = performance.now();
            console.log('Audio ended at:', audioEndTime);
          });
        }
      },
      on_finish: (data) => {
        // RT를 오디오 종료 시점부터 재계산
        data.rt_original = data.rt; // 원본 RT 보존
        
        if (audioEndTime !== null) {
          const responseTime = performance.now();
          data.rt_after_audio = Math.round(responseTime - audioEndTime);
          data.rt = data.rt_after_audio; // 새 RT로 교체
        } else {
          // 오디오 종료 감지 실패시 원본 RT 유지
          data.rt_after_audio = null;
          console.warn('Audio end time not detected, using original RT');
        }
        
        data.rating = data.response;
        data.stimulus = data.stimulus_file || data.stimulus;
        data.user_agent = navigator.userAgent;
        data.timestamp = new Date().toISOString();
        
        console.log('Trial finished:', {
          stimulus: data.stimulus,
          rt_original: data.rt_original,
          rt_after_audio: data.rt_after_audio,
          rating: data.rating
        });
      }
    };

    /* ===== RANDOM ORDER BLOCK ===== */
    const rating_block = {
      timeline: [rating_trial],
      timeline_variables: STIMULI,
      randomize_order: true
    };

    /* ===== RUN ===== */
    jsPsych.run([preload, welcome, rating_block, demographics, end]);

    /* ===== GOOGLE UPLOAD ===== */
    async function uploadAllRowsToGoogle() {
      if (!GAS_ENDPOINT || GAS_ENDPOINT.startsWith('PASTE_')) {
        console.warn('No GAS endpoint configured.');
        return false;
      }
      try {
        const rows = jsPsych.data.get().values().map(d => {
          const baseData = {
            trial_index:  d.trial_index,
            task:         d.task || '',
            stimulus:     d.stimulus || d.stimulus_file || '',
            rating:       d.rating ?? d.response,
            rt:           d.rt,
            time_elapsed: d.time_elapsed,
            timestamp:    d.timestamp || new Date().toISOString(),
            user_agent:   d.user_agent || navigator.userAgent
          };
          
          // demographics 데이터 추가
          if (d.task === 'demographics' && d.response) {
            baseData.gender = d.response.gender || '';
            baseData.birth_year = d.response.birth_year || '';
            baseData.birth_month = d.response.birth_month || '';
            baseData.native_lang = d.response.native_lang || '';
            baseData.dialect = d.response.dialect || '';
            baseData.foreign_lang = d.response.foreign_lang || '';
          } else {
            baseData.gender = '';
            baseData.birth_year = '';
            baseData.birth_month = '';
            baseData.native_lang = '';
            baseData.dialect = '';
            baseData.foreign_lang = '';
          }
          
          return baseData;
        });

        await fetch(GAS_ENDPOINT, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(rows)
        });
        console.log('Upload attempted. Check your Google Sheet.');
        return true;
      } catch (e) {
        console.warn('Upload error:', e);
        return false;
      }
    }
  </script>
</body>
</html>


